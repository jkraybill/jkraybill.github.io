<!DOCTYPE html>
<html>
<head>
	<title>scheduler</title>

	<script src="https://code.jquery.com/jquery-3.6.3.min.js" type="text/javascript"></script>
	<script src="PapaParse-5.0.2/papaparse.min.js" type="text/javascript"></script>

	<script type="text/javascript">
		var inputType = "string";
		var stepped = 0, rowCount = 0, errorCount = 0, firstError;
		var start, end;
		var firstRun = true;
		var maxUnparseLength = 10000;

		stepped = 0;
		rowCount = 0;
		errorCount = 0;
		firstError = undefined;

		var config = buildConfig();

		console.log("Loaded");

		$(function() {
			console.log("initialized");
			$('#submit').click(function() {
				console.log("Clicked");
				if (!$('#files')[0].files.length)
				{
					console.log("No file selected");
					alert("Please choose a file to parse!");
					return false;
				}

				console.log("Parsing...");

				$('#files').parse({
					config: config,
					before: function(file, inputElem)
					{
						console.log("Parsing begin");
						start = now();
						console.log("Parsing file...", file);
					},
					error: function(err, file)
					{
						console.log("ERROR:", err, file);
						firstError = firstError || err;
						errorCount++;
					},
					complete: function()
					{
						end = now();
					}
				});
			});
		});

		function buildConfig()
		{
			return {
				delimiter: ",",
				header: true,
				dynamicTyping: false,
				skipEmptyLines: true,
				preview: 0,
				step: undefined,
				worker: false,
				comments: "#",
				complete: completeFn,
				error: errorFn,
				download: false
			};
		}

		function completeFn(results)
		{
			end = now();

			if (results && results.errors)
			{
				if (results.errors)
				{
					errorCount = results.errors.length;
					firstError = results.errors[0];
				}
				if (results.data && results.data.length > 0)
					rowCount = results.data.length;
			}

			console.log("    Results:", results);

			doDraw(results.data);
		}

		function errorFn(err, file)
		{
			end = now();
			console.log("ERROR:", err, file);
		}

		function now()
		{
			return typeof window.performance !== 'undefined'
					? window.performance.now()
					: 0;
		}

		function doDraw(results) {
			// get a random person
			var persons = [];
			var deptCounts = {};
			var supportedCounts = {};

			while (persons.length < 4) {
				var legit = false;
				while (!legit) {
					var i = Math.floor(Math.random() * results.length);
					if ((deptCounts[results[i].DEPT] != 1) && (supportedCounts[results[i].SUPPORTED] != 2)) {
						legit = true;
					}
				}

				deptCounts[results[i].DEPT] = deptCounts[results[i].DEPT] ? (deptCounts[results[i].DEPT]+1) : 1;
				supportedCounts[results[i].SUPPORTED] = supportedCounts[results[i].SUPPORTED] ? (supportedCounts[results[i].SUPPORTED] + 1) : 1;
				console.log(deptCounts);
				console.log(supportedCounts);
				persons.push(results[i]);
				results.splice(i, 1);
			}

			var res = "";
			for (i = 0; i < persons.length; i++) {
				res += (i + 1) + ". " + persons[i].NAME + " - " + persons[i].DEPT + " - " + ((persons[i].SUPPORTED === "Y") ? "(supported)" : "(unsupported)") + "<br/>"
			}

			$("#results").html(res);
		}
	</script>
</head>
<body>

<form onSubmit="return false;">
Schedule CSV: <input type="file" id="files" multiple>

<button id="submit" class="green">Parse</button>

<div id="results">
</div>
</form>


</body>
</html>